#!/bin/bash

set -e

# remember to update the CVE and branch name as needed
CVE="CVE-2023-45133"
BRANCH="babel-traverse-$CVE"

# check first argument is provided
if [ -z "$1" ]; then
  echo "Usage: $0 <owner/repo>"
  echo "Example: $0 NethServer/ns8-kickstart"
  exit 1
fi

# assign the first argument to OWNER_AND_REPO
OWNER_AND_REPO="$1"

# check if gh is installed
if ! command -v gh &> /dev/null; then
  echo "gh (GitHub CLI) is not installed. Please install it first."
  exit 1
fi

# check if logged in to GitHub
if ! gh auth status &> /dev/null; then
  echo "You are not logged in to GitHub. Please log in using 'gh auth login'."
  exit 1
fi

# ensure yarn version is 1.22.x
if ! yarn --version | grep -qE '^1\.22\..+$'; then
  echo "Yarn version is not compatible, 1.22.x is required"
  exit 1
fi

# split REPO variable into owner and repo name
IFS='/' read -r OWNER REPO <<< "$OWNER_AND_REPO"

cd ~/git

echo git@github.com:"$OWNER_AND_REPO"

# clone the repository if it doesn't exist
if [ ! -d "$REPO" ]; then
  git clone git@github.com:"$OWNER_AND_REPO"
else
  echo "Repository $REPO already exists, skipping clone."
fi

cd "$REPO"
git checkout main
git pull origin main

# check if branch already exists
if git show-ref --verify --quiet refs/heads/"$BRANCH"; then
  echo "Branch $BRANCH already exists, checking out."
  git checkout "$BRANCH"
else
  echo "Creating new branch $BRANCH."
  git checkout -b "$BRANCH"
fi

cd ui

# ensure @babel/traverse is installed
if ! yarn list --pattern @babel/traverse | grep -q ' @babel/traverse@'; then
  echo "@babel/traverse is not installed, quitting."
  exit 1
fi

# find @babel/traverse version
CURRENT_VERSION=$(yarn list --pattern @babel/traverse | grep ' @babel/traverse@' | awk -F '@' '{print $3}')

echo "Current @babel/traverse version: $CURRENT_VERSION"

# check if the version is 7.23.2 or higher
if [[ "$(printf '%s\n' "$CURRENT_VERSION" "7.23.2" | sort -V | head -n1)" == "7.23.2" ]]; then
  echo "@babel/traverse version is >= 7.23.2, quitting."
  exit 1
fi

# add resolution
npm pkg set resolutions.@babel/traverse=7.23.2

yarn install

# check if the version is 1.11.0 or higher after installation
NEW_VERSION=$(yarn list --pattern @babel/traverse | grep ' @babel/traverse@' | awk -F '@' '{print $3}')

echo "@babel/traverse updated to version $NEW_VERSION"

# ensure the build works with the new version
NODE_OPTIONS=--openssl-legacy-provider yarn build

# ask for confirmation before making changes
read -p "Do you want to commit and create a pull request? (y/N): " confirm
if [[ "$confirm" != "y" ]]; then
  echo "No changes were made. Exiting now"
  exit 0
fi

git add -A
git commit -m "fix: @babel/traverse $CVE"
git push --set-upstream origin "$BRANCH"

# create a pull request
gh pr create --title "fix: @babel/traverse $CVE" --body "Fix $CVE" --reviewer Tbaile
